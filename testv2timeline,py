import os
from xmlrpc.client import DateTime
from tomlkit import datetime
import tweepy
import config
import pandas as pd
import pyodbc
import datetime as dt
import rfc3339
import iso8601

API_KEY = config.API_KEY
API_KEY_SECRET = config.SECRET_API_KEY
BEARER_TOKEN = config.MY_BEARER_TOKEN
ACCESS_TOKEN = config.ACCESS_TOKEN
ACCESS_TOKEN_SECRET = config.SECRET_ACCESS_TOKEN
MAX_RESULTS = config.MAX_RESULTS
LATEST_DATE = config.LATEST_DATE

client = tweepy.Client( bearer_token= BEARER_TOKEN, 
                        consumer_key=API_KEY, 
                        consumer_secret=API_KEY_SECRET, 
                        access_token=ACCESS_TOKEN, 
                        access_token_secret=ACCESS_TOKEN_SECRET,
                        return_type='json',
                        wait_on_rate_limit=True)
  
query = 'from:xQc'

def convertToDatetime(latestDate):
    def get_date_object(date_string):
        return iso8601.parse_date(date_string)
    
    def get_date_string(date_object):
        return rfc3339.rfc3339(date_object)
    
    test_date = get_date_object(latestDate)
    datetime = get_date_string(test_date)
    
    return datetime

datetime = convertToDatetime(LATEST_DATE)

tweets = client.get_users_tweets(id=807095, tweet_fields=['author_id', 'created_at'], max_results=MAX_RESULTS, start_time=datetime) #3200 max

columns = ['Date', 'User', 'Tweet']
data = []

# Iterate through the results and append them to the list
for tweet in tweets[0]:
    data.append([tweet['created_at'], tweet['author_id'], tweet['text']])

# Create a dataframe with the results
df = pd.DataFrame(data, columns=columns)
df.style
print(df)

df.to_csv('data.csv', mode='a')

#get latest created_at date from dataframe
latestDate = df['Date'].max()

def writeLatestDate(latestDate):
    with open('config.py', 'r', encoding='utf-8') as file:
        data = file.readlines()
    
    data[6] = 'LATEST_DATE = "' + str(latestDate) + '"'

    with open('config.py', 'w', encoding='utf-8') as file:
        file.writelines(data)

writeLatestDate(latestDate)

def dbWrite(df):
    try:
        conn = pyodbc.connect('Driver={SQL Server};'
                      'Server=Z690-ELDER;'
                      'Database=SentimentAnalysis;'
                      'Trusted_Connection=yes;')
 
        cursor = conn.cursor()
        
        #for each unique user in the dataframe
        for user in df['User'].unique():
            cursor.execute("insert into dbo.Users(TwitterId) values (?)\
                        End", row.User)
        
        for index, row in df.iterrows():
            cursor.execute("INSERT INTO dbo.Twitter (Userkey, Tweet)\
                            Select us.UserId, ?\
                            from Users us\
                            where us.TwitterId = ?", row.Tweet, row.User)
        conn.commit()
        cursor.close()
            
    except pyodbc.Error as e:
        print("Error while connecting to db", e)
        
#dbWrite(df)

print("Done")