import os
import tweepy
import config
import pandas as pd
import pyodbc

API_KEY = config.API_KEY
API_KEY_SECRET = config.SECRET_API_KEY
BEARER_TOKEN = config.MY_BEARER_TOKEN
ACCESS_TOKEN = config.ACCESS_TOKEN
ACCESS_TOKEN_SECRET = config.SECRET_ACCESS_TOKEN

client = tweepy.Client( bearer_token= BEARER_TOKEN, 
                        consumer_key=API_KEY, 
                        consumer_secret=API_KEY_SECRET, 
                        access_token=ACCESS_TOKEN, 
                        access_token_secret=ACCESS_TOKEN_SECRET,
                        return_type='json',
                        wait_on_rate_limit=True)
  
query = 'from:xQc'

tweets = client.get_users_tweets(id=807095, tweet_fields=['author_id', 'created_at'], max_results=5) #3200 max

columns = ['Time', 'User', 'Tweet']
data = []

# Iterate through the results and append them to the list
for tweet in tweets[0]:
    data.append([tweet['created_at'], tweet['author_id'], tweet['text']])

# Create a dataframe with the results
df = pd.DataFrame(data, columns=columns)
df.style
print(df)

df.to_csv('data.csv', mode='a')

def dbConnection():
    try:
        conn = pyodbc.connect('Driver={SQL Server};'
                      'Server=localhost;'
                      'Database=SentimentAnalysis;'
                      'Trusted_Connection=yes;')
 
        cursor = conn.cursor()
        
        for index, row in df.iterrows():
            cursor.execute("INSERT INTO dbo.Twitter (Userkey, Tweet)\
                            Select us.UserId, ?\
                            from dbo.Users us"\
                            join dbo., row.Tweet)
        conn.commit()
        cursor.close()    
            
    except Error as e:
        print("Error while connecting to db", e)